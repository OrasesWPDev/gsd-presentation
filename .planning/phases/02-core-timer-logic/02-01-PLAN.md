---
phase: 02-core-timer-logic
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pomodoro-timer/index.html
autonomous: true

must_haves:
  truths:
    - "User clicks Start and timer counts down from 25:00 in real-time"
    - "User clicks Stop and countdown pauses at current time"
    - "User clicks Reset and timer returns to 25:00"
    - "Timer reaches 00:00 and shows completion state visually"
  artifacts:
    - path: "pomodoro-timer/index.html"
      provides: "Timer control functions and completion handling"
      contains: "function startTimer"
    - path: "pomodoro-timer/index.html"
      provides: "Interval cleanup pattern"
      contains: "clearInterval"
    - path: "pomodoro-timer/index.html"
      provides: "Completion visual indicator"
      contains: ".complete"
  key_links:
    - from: "btn-start-stop click handler"
      to: "startTimer() or stopTimer()"
      via: "event listener checking timer.isRunning"
      pattern: "addEventListener.*click.*startTimer\\|stopTimer"
    - from: "btn-reset click handler"
      to: "resetTimer()"
      via: "event listener"
      pattern: "addEventListener.*click.*resetTimer"
    - from: "setInterval tick"
      to: "handleComplete()"
      via: "remaining <= 0 check"
      pattern: "if.*remaining.*<=.*0.*handleComplete"
---

<objective>
Implement countdown timer logic with start/stop/reset controls and completion detection.

Purpose: Transform the static Phase 1 timer display into a functional countdown timer that responds to user controls and shows clear completion state.

Output: Working timer that counts down from 25:00, responds to Start/Stop/Reset buttons, and visually indicates when complete.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-timer-logic/02-RESEARCH.md

# Phase 1 artifacts (must exist before this plan executes)
@pomodoro-timer/index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement timer control functions</name>
  <files>pomodoro-timer/index.html</files>
  <action>
Add four timer control functions to the script section of index.html:

1. **startTimer()** - Timestamp-based countdown (CRITICAL for accuracy):
   - Guard: `if (timer.intervalId !== null) return;` to prevent duplicate intervals
   - Calculate `timer.endTime = Date.now() + (timer.remainingSeconds * 1000);`
   - Set `timer.isRunning = true;`
   - Create interval with `timer.intervalId = setInterval(() => { ... }, 1000);`
   - Inside interval: calculate `remainingMs = Math.max(0, timer.endTime - Date.now());`
   - Update `timer.remainingSeconds = Math.floor(remainingMs / 1000);`
   - Call `updateDisplay();`
   - Check `if (remainingMs <= 0) handleComplete();`
   - Call `updateStartStopButton();` to toggle button text

2. **stopTimer()** - Clean interval cleanup:
   - Check `if (timer.intervalId !== null)`
   - Call `clearInterval(timer.intervalId);`
   - Set `timer.intervalId = null;`
   - Set `timer.isRunning = false;`
   - Call `updateStartStopButton();`

3. **resetTimer()** - Return to mode duration:
   - Call `stopTimer();`
   - Set `timer.remainingSeconds = timer.durations[timer.currentMode] * 60;`
   - Set `timer.endTime = null;`
   - Remove `.complete` class from timer display (if present)
   - Call `updateDisplay();`

4. **handleComplete()** - Completion state:
   - Call `stopTimer();`
   - Set `timer.remainingSeconds = 0;`
   - Call `updateDisplay();`
   - Add `.complete` class to timer-display element

5. **updateStartStopButton()** - Toggle button text:
   - Get btn-start-stop element
   - Set textContent to "Stop" if timer.isRunning, else "Start"

AVOID: Counter decrementing (`seconds--`) - this causes 10-30 second drift over 25 minutes. Use timestamp-based calculation.
  </action>
  <verify>
Open browser console, manually test:
- `startTimer()` - verify interval starts, isRunning = true
- `stopTimer()` - verify interval cleared, isRunning = false
- `resetTimer()` - verify remainingSeconds resets to 1500 (25*60)
- Confirm no console errors
  </verify>
  <done>
All four timer functions exist and work correctly when called directly from console. Button text toggles between Start/Stop.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire event listeners and add completion CSS</name>
  <files>pomodoro-timer/index.html</files>
  <action>
1. **Add completion CSS** to the style section:
   ```css
   .timer-display.complete {
       color: #27ae60;  /* Green for success */
       animation: pulse 1s ease-in-out infinite;
   }

   @keyframes pulse {
       0%, 100% { opacity: 1; }
       50% { opacity: 0.5; }
   }
   ```

2. **Add event listeners** at the end of the script section (after function definitions):

   Start/Stop toggle button:
   ```javascript
   document.getElementById('btn-start-stop').addEventListener('click', () => {
       if (timer.isRunning) {
           stopTimer();
       } else {
           startTimer();
       }
   });
   ```

   Reset button (add this button to HTML if not present, next to Start/Stop):
   ```html
   <button id="btn-reset" class="control-btn">Reset</button>
   ```

   Reset event listener:
   ```javascript
   document.getElementById('btn-reset').addEventListener('click', () => {
       resetTimer();
   });
   ```

3. **Ensure initial state** - call at end of script:
   ```javascript
   updateDisplay();  // Sync display with state on load
   ```

AVOID: Inline onclick handlers - use addEventListener for clean separation.
  </action>
  <verify>
Open index.html in browser:
1. Click Start - timer counts down, button shows "Stop"
2. Click Stop - timer pauses, button shows "Start"
3. Click Start again - timer resumes from paused time
4. Click Reset - timer returns to 25:00, button shows "Start"
5. Let timer run to 00:00 - display turns green and pulses
  </verify>
  <done>
Complete user flow works: Start begins countdown, Stop pauses, Reset returns to 25:00, completion shows green pulsing display.
  </done>
</task>

</tasks>

<verification>
After both tasks complete, verify the full Phase 2 success criteria:

1. **Countdown accuracy test:**
   - Start timer, note actual clock time
   - Wait 60 seconds (or use a shorter test duration)
   - Verify timer shows correct remaining time (within 1 second)

2. **Pause/resume test:**
   - Start timer at 25:00
   - Stop at ~24:30
   - Wait 30 seconds (real time)
   - Start again
   - Timer should resume from ~24:30, NOT ~24:00

3. **Reset test:**
   - Start timer
   - Let it count down to ~23:00
   - Click Reset
   - Timer shows 25:00, is not running

4. **Completion test:**
   - Set timer.remainingSeconds = 3 in console
   - Call startTimer()
   - Wait 3 seconds
   - Timer shows 00:00 with green pulsing animation
   - Button shows "Start"

5. **No drift test (abbreviated):**
   - Start timer
   - Switch to another browser tab for 30 seconds
   - Return to timer tab
   - Timer should show correct time (auto-corrected by timestamp calculation)
</verification>

<success_criteria>
- [ ] startTimer() uses timestamp-based calculation (timer.endTime = Date.now() + remaining)
- [ ] stopTimer() clears interval and sets intervalId to null
- [ ] resetTimer() returns to current mode's duration (1500 seconds for pomodoro)
- [ ] handleComplete() adds .complete class for visual feedback
- [ ] Start button toggles timer state and shows Stop/Start text
- [ ] Reset button returns timer to 25:00
- [ ] Timer displays 00:00 with green pulsing when complete
- [ ] No timer drift after pause/resume or background tab
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-timer-logic/02-01-SUMMARY.md`
</output>
